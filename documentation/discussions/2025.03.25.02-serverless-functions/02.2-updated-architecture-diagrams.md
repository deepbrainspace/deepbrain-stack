Date: 2025-03-25
---

# Updated Architecture Diagrams

Based on the serverless function recommendations, here are updated architecture diagrams that incorporate the new components and data flows.

## Updated System Architecture

```mermaid
graph TB
    subgraph "Cloudflare"
        CF_DNS["DNS"]
        CF_R2["R2 Storage"]
        CF_Workers["Workers"]
        CF_AircallWorker["Aircall Webhook Worker"]
        CF_GuestyWorker["Guesty Webhook Worker"]
        CF_LLMWorker["LLM Query Worker"]
    end

    subgraph "Hetzner Cloud"
        subgraph "Docker Swarm Cluster"
            DS_Node1["Node 1\nManager + Worker"]
            DS_Node2["Node 2\nManager + Worker"]
            DS_Node3["Node 3\nManager + Worker"]
            
            subgraph "Core Services"
                Core_SeaweedFS["SeaweedFS"]
                Core_Traefik["Traefik"]
                Core_Netdata["Netdata"]
            end
            
            subgraph "Applications"
                App_RocketChat["RocketChat"]
                App_MongoDB["MongoDB"]
                App_Keycloak["Keycloak"]
                App_Sync["Sync App"]
                App_MongoListener["MongoDB Change Stream Listener"]
            end
        end
        
        HZ_BackupSnapshot["Backup Server Snapshot"]
        HZ_Network["Private Network"]
        HZ_Firewall["Firewall"]
    end

    subgraph "GCP"
        GCP_Firestore["Firestore"]
        GCP_Functions["Cloud Functions"]
        GCP_CloudRun["Cloud Run"]
        GCP_Scheduler["Cloud Scheduler"]
        GCP_BackupFunction["Backup Function"]
        GCP_VectorizeFunction["Vectorize Function"]
        GCP_PubSub["Pub/Sub"]
    end

    subgraph "Vercel"
        Vercel_SecretsUI["Secrets UI"]
    end

    subgraph "External Services"
        Qdrant["Qdrant Cloud\nVector DB"]
        Groq["Groq Cloud\nInference"]
        Aircall["Aircall API"]
        Guesty["Guesty API"]
    end

    %% Connections
    CF_DNS --> HZ_Firewall
    CF_Workers --> HZ_Firewall
    
    DS_Node1 <--> DS_Node2
    DS_Node2 <--> DS_Node3
    DS_Node3 <--> DS_Node1
    
    DS_Node1 <--> HZ_Network
    DS_Node2 <--> HZ_Network
    DS_Node3 <--> HZ_Network
    
    Core_SeaweedFS <--> App_RocketChat
    Core_SeaweedFS <--> App_MongoDB
    Core_SeaweedFS <--> App_Keycloak
    Core_SeaweedFS <--> App_Sync
    
    Core_Traefik --> HZ_Firewall
    
    GCP_BackupFunction --> HZ_BackupSnapshot
    HZ_BackupSnapshot --> CF_R2
    
    GCP_Scheduler --> GCP_BackupFunction
    
    Aircall --> CF_AircallWorker
    Guesty --> CF_GuestyWorker
    
    CF_AircallWorker --> GCP_Firestore
    CF_GuestyWorker --> GCP_Firestore
    
    GCP_Firestore --> GCP_VectorizeFunction
    GCP_VectorizeFunction --> Qdrant
    
    App_MongoDB <--> App_MongoListener
    App_MongoListener --> GCP_PubSub
    GCP_PubSub --> GCP_Functions
    GCP_Functions --> Qdrant
    
    App_RocketChat --> CF_LLMWorker
    CF_LLMWorker --> Qdrant
    CF_LLMWorker --> Groq
    CF_LLMWorker --> App_RocketChat
    
    App_RocketChat <--> GCP_Firestore
    App_Sync <--> GCP_Firestore
    
    App_Sync <--> Qdrant
    App_Sync <--> Groq
    
    Vercel_SecretsUI <--> CF_Workers
    
    classDef cloudflare fill:#F6821F,color:white;
    classDef hetzner fill:#D50C2D,color:white;
    classDef gcp fill:#4285F4,color:white;
    classDef vercel fill:#000000,color:white;
    classDef external fill:#666666,color:white;
    classDef swarm fill:#2496ED,color:white;
    classDef core fill:#2496ED,color:white,stroke-dasharray: 5 5;
    classDef apps fill:#2496ED,color:white,stroke-dasharray: 5 5;
    
    class CF_DNS,CF_R2,CF_Workers,CF_AircallWorker,CF_GuestyWorker,CF_LLMWorker cloudflare;
    class DS_Node1,DS_Node2,DS_Node3,HZ_BackupSnapshot,HZ_Network,HZ_Firewall hetzner;
    class Core_SeaweedFS,Core_Traefik,Core_Netdata core;
    class App_RocketChat,App_MongoDB,App_Keycloak,App_Sync,App_MongoListener apps;
    class GCP_Firestore,GCP_Functions,GCP_CloudRun,GCP_Scheduler,GCP_BackupFunction,GCP_VectorizeFunction,GCP_PubSub gcp;
    class Vercel_SecretsUI vercel;
    class Qdrant,Groq,Aircall,Guesty external;
```

## Backup Process Flow (Updated)

```mermaid
flowchart TD
    A[Google Cloud Scheduler] -->|Daily Trigger| B[Backup Cloud Function]
    B -->|Determine Backup Type| C{Backup Type}
    C -->|Daily| D[Create Server from Snapshot]
    C -->|Weekly| D
    C -->|Monthly| D
    
    D --> E[Server Boots and Runs Backup]
    E -->|Mount SeaweedFS| F[Backup Volumes]
    F --> G[Upload to Cloudflare R2]
    
    G --> H{Apply Retention Policy}
    H -->|Daily| I[Keep 7 Days]
    H -->|Weekly| J[Keep 4 Weeks]
    H -->|Monthly| K[Keep 12 Months]
    
    G --> L[Update Status in Firestore]
    L --> M[Send Notification to Monitoring]
    M --> N[Server Self-Destructs]
    
    classDef gcp fill:#4285F4,color:white;
    classDef hetzner fill:#D50C2D,color:white;
    classDef cloudflare fill:#F6821F,color:white;
    classDef process fill:#4CAF50,color:white;
    classDef decision fill:#9C27B0,color:white;
    
    class A,B gcp;
    class D,E,F,N hetzner;
    class G,H,I,J,K cloudflare;
    class L,M process;
    class C decision;
```

## API Integration Flow

```mermaid
flowchart TD
    A1[Aircall API] -->|Webhook Event| B1[Aircall Cloudflare Worker]
    A2[Guesty API] -->|Webhook Event| B2[Guesty Cloudflare Worker]
    
    B1 -->|Validate & Transform| C[Firestore Database]
    B2 -->|Validate & Transform| C
    
    C -->|Document Write Trigger| D[Vectorize Cloud Function]
    D -->|Create Vector Representation| E[Qdrant Vector Database]
    
    classDef external fill:#666666,color:white;
    classDef cloudflare fill:#F6821F,color:white;
    classDef gcp fill:#4285F4,color:white;
    classDef qdrant fill:#00C4CC,color:white;
    
    class A1,A2 external;
    class B1,B2 cloudflare;
    class C,D gcp;
    class E qdrant;
```

## RocketChat Message Vectorization Flow

```mermaid
flowchart TD
    A[RocketChat] -->|New Message| B[MongoDB]
    B -->|Change Stream| C[MongoDB Listener Service]
    C -->|Message Event| D[Google Pub/Sub]
    D -->|Trigger| E[Vectorize Function]
    E -->|Create Vector| F[Qdrant Vector Database]
    
    classDef app fill:#2496ED,color:white;
    classDef db fill:#47A248,color:white;
    classDef service fill:#4CAF50,color:white;
    classDef gcp fill:#4285F4,color:white;
    classDef qdrant fill:#00C4CC,color:white;
    
    class A app;
    class B db;
    class C service;
    class D,E gcp;
    class F qdrant;
```

## LLM Query Process Flow

```mermaid
flowchart TD
    A[RocketChat User] -->|Ask Question| B[RocketChat]
    B -->|Webhook| C[LLM Query Cloudflare Worker]
    
    C -->|Query for Context| D[Qdrant Vector Database]
    D -->|Return Relevant Context| C
    
    C -->|Query with Context| E[Groq LLM API]
    E -->|Return Response| C
    
    C -->|Format Response| B
    B -->|Display Answer| A
    
    C -->|Store Q&A| F[Firestore]
    F -->|Trigger| G[Vectorize Function]
    G -->|Update Vector DB| D
    
    classDef user fill:#1976D2,color:white;
    classDef app fill:#2496ED,color:white;
    classDef cloudflare fill:#F6821F,color:white;
    classDef qdrant fill:#00C4CC,color:white;
    classDef groq fill:#FF4081,color:white;
    classDef gcp fill:#4285F4,color:white;
    
    class A user;
    class B app;
    class C cloudflare;
    class D qdrant;
    class E groq;
    class F,G gcp;
```