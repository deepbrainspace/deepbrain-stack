# Infrastructure Deployment Strategy v7

## Overview
Based on the requirements for a multi-cloud infrastructure spanning Hetzner, Cloudflare, GCP, Qdrant Cloud, and Groq Cloud, with a focus on high availability and automation, here's a refined approach that leverages Ansible's powerful templating capabilities with GitHub Actions for orchestration and proper validation.

## Core Architecture Components

### 1. Infrastructure Provisioning
- **Terraform** for all cloud resources (Hetzner, Cloudflare, GCP)
- Environment-specific configurations
- Remote state storage for collaboration

### 2. Configuration Management
- **Ansible** for server setup and application configuration templating
- Environment variables in separate YAML files organized by application
- Git-crypt for encrypting sensitive information

### 3. Deployment Automation
- **GitHub Actions** for CI/CD pipeline and Ansible orchestration
- PR-based workflow with validation and preview
- Post-deployment verification

### 4. Container Orchestration
- **Docker Swarm** for simplicity and HA
- SeaweedFS for distributed storage
- Traefik for routing and load balancing

## Architecture Diagram

```
+------------------------------------------+
|                                          |
|              Cloudflare                  |
|  +--------+  +-------+  +-------------+  |
|  |  DNS   |  |  R2   |  |  Workers    |  |
|  +--------+  +-------+  +-------------+  |
|        |         |            |          |
+--------|---------|------------|----------+
         |         |            |
         v         v            v
+------------------------------------------+
|                                          |
|            Hetzner Cloud                 |
|                                          |
| +----------------+    +----------------+ |
| |                |    |                | |
| | Docker Swarm   |    | Backup Server  | |
| | Cluster        |<-->| (SeaweedFS     | |
| | (3 nodes)      |    |  mounter)      | |
| |                |    |                | |
| +-------^--------+    +--------^-------+ |
|         |                      |         |
| +-------v--------+    +--------v-------+ |
| |                |    |                | |
| | Private        |    | Firewall       | |
| | Network        |    |                | |
| |                |    |                | |
| +----------------+    +----------------+ |
|                                          |
+------------------------------------------+
         |                    |
         v                    v
+------------------+  +------------------+
|                  |  |                  |
| GCP              |  | Vercel           |
| +------------+   |  | +------------+   |
| | Firestore  |   |  | | Secrets UI |   |
| +------------+   |  | +------------+   |
| | Functions  |   |  |                  |
| +------------+   |  |                  |
| | Cloud Run  |   |  |                  |
| +------------+   |  |                  |
|                  |  +------------------+
+------------------+
         |
         v
+------------------+  +------------------+
|                  |  |                  |
| Qdrant Cloud     |  | Groq Cloud      |
| +------------+   |  | +------------+   |
| | Vector DB  |   |  | | Inference  |   |
| +------------+   |  | +------------+   |
|                  |  |                  |
+------------------+  +------------------+
```

## Deployment Workflow

```
+-------------+     +-------------+     +-------------+
| Git Repo    |     | GitHub      |     | Deployment  |
| (Source)    |---->| Actions     |---->| Target      |
+-------------+     +-------------+     +-------------+
      ^                    |                  |
      |                    v                  |
      |             +-------------+           |
      |             | Validation  |           |
      |             | & Preview   |           |
      |             +-------------+           |
      |                                       |
      +---------------------------------------+
                 Feedback Loop
```

## Ansible-Based Configuration with GitHub Actions

### Refined Ansible Structure with Application-Specific Variables
1. **Centralized Configuration with Better Organization**:
   - Store all application configurations as Ansible templates
   - Organize environment variables by both environment and application
   - Use Ansible roles for different components (core services, apps)

2. **Benefits of Refined Structure**:
   - Better separation of concerns
   - Easier to manage application-specific configurations
   - Clearer organization for team members
   - Simplified updates for individual applications

### GitHub Actions for Orchestration
1. **Deployment Workflow**:
   - Triggered by PR creation and merges
   - Performs validation before running Ansible
   - Executes Ansible in controlled environment
   - Reports results back to PR or commit

2. **Validation Process**:
   - **PR Validation**: Dry-run Ansible when PR is created
   - **Diff Generation**: Show changes that would be applied
   - **Syntax Checking**: Validate all templates and variables
   - **Post-Deployment Verification**: Confirm services are healthy

3. **Rollback Capability**:
   - Store previous configurations
   - Automatic rollback on failure
   - Manual rollback option

## Directory Structure

```
infrastructure/
├── terraform/
│   ├── modules/
│   │   ├── hetzner-swarm/
│   │   ├── hetzner-network/
│   │   ├── cloudflare/
│   │   └── gcp/
│   ├── environments/
│       ├── dev/
│       ├── staging/
│       └── prod/
├── ansible/
│   ├── playbooks/
│   │   ├── setup-servers.yml
│   │   ├── deploy-core.yml
│   │   └── deploy-apps.yml
│   ├── inventory/
│   │   ├── dev
│   │   ├── staging
│   │   └── prod
│   ├── roles/
│   │   ├── common/
│   │   ├── docker/
│   │   ├── core/
│   │   │   ├── seaweedfs/
│   │   │   ├── traefik/
│   │   │   └── netdata/
│   │   └── apps/
│   │       ├── rocketchat/
│   │       ├── keycloak/
│   │       └── sync-app/
│   └── group_vars/
│       ├── all/
│       │   └── common.yml
│       ├── dev/
│       │   ├── common.yml
│       │   ├── rocketchat.yml
│       │   ├── keycloak.yml
│       │   └── sync-app.yml
│       ├── staging/
│       │   └── (similar structure)
│       └── prod/
│           └── (similar structure)
├── .github/
│   └── workflows/
│       ├── pr-validation.yml
│       ├── deploy.yml
│       └── backup-verify.yml
├── scripts/
│   ├── validate-ansible.sh
│   ├── backup-verify.sh
│   └── generate-diff.sh
└── secrets/
    ├── dev/
    ├── staging/
    └── prod/
```

## Ansible Role Structure Example

```
roles/
└── apps/
    └── rocketchat/
        ├── defaults/
        │   └── main.yml       # Default variables
        ├── tasks/
        │   └── main.yml       # Deployment tasks
        ├── templates/
        │   ├── rocketchat.j2  # Docker Compose template
        │   └── nginx.conf.j2  # Nginx config template
        └── vars/
            └── main.yml       # Role-specific variables
```

## Environment and Application-Specific Variables

```
group_vars/
├── all/
│   └── common.yml             # Variables common to all environments
├── dev/
│   ├── common.yml             # Environment-wide variables
│   ├── rocketchat.yml         # RocketChat specific variables for dev
│   ├── keycloak.yml           # Keycloak specific variables for dev
│   └── sync-app.yml           # Sync app specific variables for dev
├── staging/
│   └── (similar structure)
└── prod/
    └── (similar structure)
```

Example of application-specific configuration:

```yaml
# group_vars/dev/rocketchat.yml
rocketchat:
  domain: chat.dev.example.com
  replicas: 1
  memory: 1G
  features:
    video_calls: false
    file_sharing: true
  integrations:
    keycloak: true
    slack: false
```

```yaml
# group_vars/prod/rocketchat.yml
rocketchat:
  domain: chat.example.com
  replicas: 3
  memory: 2G
  features:
    video_calls: true
    file_sharing: true
  integrations:
    keycloak: true
    slack: true
```

## GitHub Actions Workflow Examples

### PR Validation Workflow

```yaml
# .github/workflows/pr-validation.yml
name: PR Validation
on:
  pull_request:
    paths:
      - 'ansible/**'
      - 'terraform/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint
      - name: Decrypt secrets
        run: |
          echo "${{ secrets.GIT_CRYPT_KEY }}" | base64 -d > git-crypt-key
          git-crypt unlock git-crypt-key
      - name: Validate Ansible
        run: |
          ansible-lint ansible/
      - name: Generate diff (check mode)
        run: |
          ./scripts/generate-diff.sh
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('ansible-diff.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Ansible Changes Preview\n```diff\n' + diff + '\n```'
            });
```

### Deployment Workflow

```yaml
# .github/workflows/deploy.yml
name: Deploy
on:
  push:
    branches: [main]
    paths:
      - 'ansible/**'
      - 'terraform/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible
      - name: Decrypt secrets
        run: |
          echo "${{ secrets.GIT_CRYPT_KEY }}" | base64 -d > git-crypt-key
          git-crypt unlock git-crypt-key
      - name: Deploy with Ansible
        run: |
          ansible-playbook ansible/playbooks/deploy-core.yml -i ansible/inventory/prod
          ansible-playbook ansible/playbooks/deploy-apps.yml -i ansible/inventory/prod
      - name: Verify deployment
        run: |
          ./scripts/verify-deployment.sh
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Deployment failed',
              body: 'Deployment failed in workflow run: ' + context.runId
            });
```

## GitHub Actions vs Serverless Functions

After careful consideration, GitHub Actions is recommended over serverless functions for this architecture:

1. **Advantages of GitHub Actions**:
   - Tightly integrated with Git workflow
   - Built-in secrets management
   - No additional infrastructure to maintain
   - Familiar to most developers
   - Extensive marketplace of pre-built actions
   - Built-in logging and history

2. **When Serverless Functions Would Be Better**:
   - For event-driven operations outside of Git workflow
   - For user-facing interfaces (like the Vercel Secrets UI)
   - For high-frequency operations
   - For operations that need to run continuously

3. **Recommendation**:
   - Use GitHub Actions for deployment orchestration
   - Keep serverless functions for specific use cases:
     - Vercel app for secrets UI
     - Cloudflare Workers for edge functionality
     - GCP Functions for integration with other GCP services

## Addressing Ansible Safety Concerns

1. **Check Mode First**:
   - Always run Ansible in check mode before applying
   - Generate detailed diff of changes
   - Require approval via PR process

2. **Controlled Environment**:
   - Run Ansible from GitHub Actions, not directly on servers
   - Use limited credentials with specific permissions
   - Log all actions for audit trail

3. **Monitoring and Alerting**:
   - Monitor deployment process in real-time
   - Alert on failures or unexpected changes
   - Integrate with existing monitoring systems

4. **Automated Testing**:
   - Test Ansible playbooks in staging environment
   - Validate templates with automated tests
   - Verify idempotence (running twice produces same result)

## Secrets Management with Git-crypt

1. **Setup**:
   - Initialize git-crypt in repository
   - Add team members' GPG keys
   - Define `.gitattributes` to specify encrypted files

2. **Usage**:
   - Store secrets in designated files
   - Commit normally - git-crypt handles encryption
   - Team members can decrypt with their GPG keys

3. **CI/CD Integration**:
   - Store symmetric key in GitHub Secrets
   - Decrypt in GitHub Actions
   - Pass to Ansible as needed

## Deployment Process

1. **Infrastructure Provisioning**:
   - Terraform creates all cloud resources
   - Outputs are stored in Terraform state

2. **Server Setup**:
   - Ansible configures servers
   - Docker is installed and Swarm initialized

3. **Application Deployment**:
   - Developer commits changes to Git
   - PR created with configuration changes
   - GitHub Actions runs Ansible in check mode
   - PR shows diff of changes
   - After approval and merge, changes are applied
   - GitHub Actions runs Ansible in apply mode
   - Verification confirms successful deployment

4. **Monitoring and Maintenance**:
   - Netdata monitors system health
   - Backup verification runs on schedule
   - Configuration changes follow same PR process

## Recommendations

1. **Use Ansible with Application-Specific Variables**:
   - Leverage Ansible's powerful templating
   - Organize variables by environment and application
   - Use GitHub Actions for safe execution
   - Implement proper validation and preview

2. **Implement Environment-Based Configuration**:
   - Separate variables by environment
   - Further separate by application within each environment
   - Maintain common configurations in roles

3. **Use Git-crypt for Secrets**:
   - Single source of truth for secrets
   - Works across all tools and platforms
   - Secure and auditable

4. **Choose GitHub for Repository and CI/CD**:
   - Better integration with the overall workflow
   - Superior PR review process
   - Extensive marketplace

## Next Steps

1. **Platform Setup**:
   - Create GitHub repository
   - Set up GitHub Actions workflows
   - Configure git-crypt for secrets

2. **Infrastructure Setup**:
   - Create Terraform modules
   - Define infrastructure for each environment
   - Implement server setup playbooks

3. **Ansible Structure**:
   - Define roles and playbooks
   - Create templates for all services
   - Set up environment and application-specific variables

4. **Deployment Automation**:
   - Implement GitHub Actions workflows
   - Create validation and preview process
   - Set up deployment verification